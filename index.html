<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"/>

  <title>브랜드페이 위젯 샘플 프로젝트</title>
  <script src="https://js.tosspayments.com/v2/standard"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      -ms-scrollbar-style: none;
      scrollbar-width: none;
    }

    html::-webkit-scrollbar {
      display: none;
    }

    body::-webkit-scrollbar {
      display: none;
    }

    #__tosspayments_brandpay_iframe__ {
      position: relative !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      margin: 0 !important;
    }

    .wrapper {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
      width: 100%;
      height: 100%;
      -ms-scrollbar-style: none;
      scrollbar-width: none;
    }

    .wrapper::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body>
<script defer>
  var brandpay = null

  const receiver = navigator.userAgent.includes('Android') ? document : window
  const reactNativeWebview = window.ReactNativeWebView

  const ACTIONS = {
    INIT_BRAND_PAY: (data) => {
      try {
        reactNativeWebview?.postMessage(JSON.stringify({message: 'INIT_BRAND_PAY'}))
        console.log('INIT_BRAND_PAY')
        const {clientKey, customerKey, redirectUrl} = data
        const tossPayments = TossPayments(clientKey)
        brandpay = tossPayments.brandpay({customerKey, redirectUrl})
      } catch (e) {
        ACTIONS.ERROR_HANDLER(e, 'INIT_BRAND_PAY')
      }
    },
    ADD_PAYMENT_METHOD: async () => {
      try {
        reactNativeWebview?.postMessage(JSON.stringify({message: 'ADD_PAYMENT_METHOD'}))
        console.log('ADD_PAYMENT_METHOD')
        await brandpay.addPaymentMethod()
        const sendObj = {key: 'ADD_PAYMENT_METHOD', status: 'SUCCESS'}
        const sendMessage = JSON.stringify(sendObj)
        reactNativeWebview?.postMessage(sendMessage)
        receiver.removeEventListener('message', handleMessage)
      } catch (e) {
        ACTIONS.ERROR_HANDLER(e, 'ADD_PAYMENT_METHOD')
      }
    },
    REQUEST_PAYMENT: async (paymentData) => {
      try {
        reactNativeWebview?.postMessage(JSON.stringify({message: 'REQUEST_PAYMENT'}))
        console.log('REQUEST_PAYMENT')
        const methods = await brandpay.requestPayment(paymentData)
        const sendObj = {key: 'REQUEST_PAYMENT', status: 'SUCCESS', data: methods}
        const sendMessage = JSON.stringify(sendObj)
        reactNativeWebview?.postMessage(sendMessage)
        receiver.removeEventListener('message', handleMessage)
      } catch (e) {
        ACTIONS.ERROR_HANDLER(e, 'REQUEST_PAYMENT')
      }
    },
    OPEN_SETTINGS: async () => {
      try {
        reactNativeWebview?.postMessage(JSON.stringify({message: 'OPEN_SETTINGS'}))
        console.log('OPEN_SETTINGS')
        await brandpay.openSettings()
        const sendObj = {key: 'OPEN_SETTINGS', status: 'SUCCESS'}
        const sendMessage = JSON.stringify(sendObj)
        reactNativeWebview?.postMessage(sendMessage)
        receiver.removeEventListener('message', handleMessage)
      } catch (e) {
        ACTIONS.ERROR_HANDLER(e, 'OPEN_SETTINGS')
      }
    },
    GO_BACK: () => {
      reactNativeWebview?.postMessage(JSON.stringify({message: 'GO_BACK'}))
      const sendObj = {key: 'GO_BACK', status: 'FAILED'}
      const sendMessage = JSON.stringify(sendObj)
      reactNativeWebview?.postMessage(sendMessage)
      receiver.removeEventListener('message', handleMessage)
    },
    ERROR_HANDLER: (e, occurredSite) => {
      const sendObj = {
        key: e.code ?? 'UNKNOWN_ERROR',
        status: 'FAILED',
        data: {
          log: e,
          message: e.message,
          occurredSite,
        }
      }

      console.log(sendObj)
      const sendMessage = JSON.stringify(sendObj)
      reactNativeWebview?.postMessage(sendMessage)
      receiver.removeEventListener('message', handleMessage)
    }
  }

  const handleMessage = (event) => {
    try {
      console.log(event)
      reactNativeWebview?.postMessage(JSON.stringify(event))
      const data = !event.data || event.data === 'undefined' ? null : JSON.parse(event.data)

      console.log(data)
      if (data === null) {
        throw new Error('data 없음')
      }

      if (brandpay === null) {
        reactNativeWebview?.postMessage(JSON.stringify({message: '브랜드페이 객체 생성'}))
        ACTIONS.INIT_BRAND_PAY(data.initData)
      }

      ACTIONS[data.key](data?.args)
    } catch (e) {
      reactNativeWebview?.postMessage(JSON.stringify({message: e.message}))
    }
  }

  receiver.addEventListener('message', handleMessage)
</script>
<script>
  var customerKey = '1b53c60b-919a-4d78-b066-fbb1e1676b1f'
  var redirectUrl = 'https://api.wefun.co.kr/wefun24/v1/payments/callback-auth'

  const addCard = {
    data: JSON.stringify({
      key: 'ADD_PAYMENT_METHOD',
      initData: {
        clientKey: 'test_ck_GePWvyJnrKRJ4BOqqyZ6VgLzN97E',
        customerKey,
        redirectUrl
      },
    })
  }

  const paymentData = {
    data: JSON.stringify({
      key: 'REQUEST_PAYMENT',
      initData: {
        clientKey: 'test_ck_GePWvyJnrKRJ4BOqqyZ6VgLzN97E',
        customerKey,
      },
      args: {
        amount: {
          currency: 'KRW',
          value: 50000,
        },
        orderId: "8t-q_UKCPV5MTXWFcHPrR",
        orderName: '토스 티셔츠 외 2건',
        customerEmail: 'test@snack24h.com',
        customerName: '김토스',
      }
    })
  }

  const openSettingData = {
    data: JSON.stringify({
      key: 'OPEN_SETTINGS',
      initData: {
        clientKey: 'test_ck_GePWvyJnrKRJ4BOqqyZ6VgLzN97E',
        customerKey,
      },
    })
  }

  const handleChangeCustomerKey = (e) => {
    customerKey = e.target.value
  }

  const handleChangeRedirectUrl = (e) => {
    customerKey = e.target.value
  }
</script>

<div class="wrapper">
  <img src="https://image.snack24h.com/static/images/wefun-logo.png" alt="위펀 로고"
       onclick="ACTIONS.GO_BACK()"/>

  <div>
    <strong>customerKey 등록</strong>
    <div>
      <input type="text" onchange="handleChangeCustomerKey"/>
      <button>등록</button>
    </div>
  </div>

  <div>
    <strong>redirectUrl 등록</strong>
    <div>
      <input type="text" onchange="handleChangeRedirectUrl"/>
      <button>등록</button>
    </div>
  </div>

  <button onclick="handleMessage(addCard)">카드등록</button>
  <button onclick="handleMessage(paymentData)">결제하기</button>
  <button onclick="handleMessage(openSettingData)">결제관리</button>
</div>
</body>
</html>
